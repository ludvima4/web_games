<!DOCTYPE html>
{% load static %}
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>Geodetická hra | Dobble</title>
  <style>
    body { background: #2c3e50; color: #ecf0f1; font-family: Arial, sans-serif; text-align: center; }
    .canvas-wrap { display: flex; justify-content: center; gap: 40px; margin: 30px 0 20px 0;}
    canvas { background: white; border-radius: 50%; }
    #score, #timer { font-size: 26px; font-weight: bold; margin: 10px 40px; }
    #start-btn, #stop-btn { font-size: 1.2em; padding: 12px 42px; border: none; border-radius: 7px; margin: 24px 10px;}
    #start-btn { background: #27ae60; color: #fff; }
    #start-btn:disabled { background: #888; }
    #stop-btn { background: #e74c3c; color: #fff; }
  </style>
</head>
<body>
  <h1>Geodetická hra: Najdi stejný symbol!</h1>
  <div>
    <span id="score">Skóre: 0</span>
    <span id="timer">Čas: 60s</span>
  </div>
  <div>
    <p>Najdi stejný symbol na obou kartách a klikni na něj!</p>
    <button id="start-btn">START HRU</button>
    <button id="stop-btn">KONEC HRY</button>
  </div>
  <div class="canvas-wrap">
    <canvas id="card1" width="340" height="340"></canvas>
    <canvas id="card2" width="340" height="340"></canvas>
  </div>

  <script>
    // URL stránky s vašimi hrami
    const HOME_URL = '/games';

    // CSRF token z cookies (PRO KOMUNIKACI S DJANGO)
    // --- NOVÉ ---
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    // Odeslání skóre na backend
    // --- NOVÉ ---
    function sendScoreToBackend(finalScore) {
      const csrftoken = getCookie('csrftoken');
      // console.log(`Ukládám skóre: ${finalScore}`); // Pro debug
      
      fetch('/score/save_score/', { 
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({
            score: finalScore, 
            hra: 'dobble' 
        })
      })
      .then(response => response.json())
      .then(data => {
          if (data.status === 'success') {
              console.log('Skóre uloženo.');
          } else {
              console.error('Chyba při ukládání:', data.message);
          }
      })
      .catch((error) => {
          console.error('Chyba sítě:', error);
      });
    }

    // každý symbol = přímo URL na obrázek
    const SYMBOLS = [
      "{% static 'img/dobble/image1.png' %}",
      "{% static 'img/dobble/image2.png' %}",
      "{% static 'img/dobble/image3.png' %}",
      "{% static 'img/dobble/image4.png' %}",
      "{% static 'img/dobble/image5.png' %}",
      "{% static 'img/dobble/image6.png' %}",
      "{% static 'img/dobble/image7.png' %}",
      "{% static 'img/dobble/image8.png' %}",
      "{% static 'img/dobble/image9.png' %}",
      "{% static 'img/dobble/image10.png' %}",
      "{% static 'img/dobble/image11.png' %}",
      "{% static 'img/dobble/image12.png' %}",
      "{% static 'img/dobble/image13.png' %}",
      "{% static 'img/dobble/image14.png' %}",
      "{% static 'img/dobble/image15.png' %}",
      "{% static 'img/dobble/image16.png' %}",
      "{% static 'img/dobble/image17.png' %}",
      "{% static 'img/dobble/image18.png' %}",
      "{% static 'img/dobble/image19.png' %}",
      "{% static 'img/dobble/image20.png' %}",
      "{% static 'img/dobble/image21.png' %}",
      "{% static 'img/dobble/image22.png' %}",
      "{% static 'img/dobble/image23.png' %}",
      "{% static 'img/dobble/image24.png' %}",
      "{% static 'img/dobble/image25.png' %}"
    ];

    const loadedImages = {};

    // načteme všechny URL ze SYMBOLS
    function loadImages(callback) {
      let loaded = 0;
      const total = SYMBOLS.length;
      SYMBOLS.forEach(url => {
        const img = new Image();
        img.src = url;
        img.onload = () => {
          loadedImages[url] = img;
          loaded++;
          if (loaded === total) callback();
        };
      });
    }

    const cardSize = 340;
    const center = cardSize / 2;
    const outerRadius = 160;
    const innerRadius = 122;

    let score = 0;
    let timeLimit = 60;
    let remainingTime = timeLimit;
    let timer = null;
    let startTime = null;
    let gameRunning = false;
    let commonSymbol = null;
    let cardSymbols = [[],[]];

    const scoreEl = document.getElementById('score');
    const timerEl = document.getElementById('timer');
    const card1 = document.getElementById('card1');
    const card2 = document.getElementById('card2');
    const startBtn = document.getElementById('start-btn');
    const stopBtn = document.getElementById('stop-btn');

    function generateCards() {
      const common = SYMBOLS[Math.floor(Math.random() * SYMBOLS.length)];
      let pool1 = SYMBOLS.filter(sym => sym !== common);
      let card1_uniques = [];
      while(card1_uniques.length < 8) {
        let idx = Math.floor(Math.random() * pool1.length);
        card1_uniques.push(pool1[idx]);
        pool1.splice(idx,1);
      }
      let first = [...card1_uniques, common];

      let pool2 = SYMBOLS.filter(sym => !first.includes(sym) && sym !== common);
      let card2_uniques = [];
      while(card2_uniques.length < 8 && pool2.length>0) {
        let idx = Math.floor(Math.random() * pool2.length);
        card2_uniques.push(pool2[idx]);
        pool2.splice(idx,1);
      }
      while(card2_uniques.length < 8) {
        let candidate;
        do {
          candidate = SYMBOLS[Math.floor(Math.random() * SYMBOLS.length)];
        } while (candidate === common || card2_uniques.includes(candidate));
        card2_uniques.push(candidate);
      }
      let second = [...card2_uniques, common];

      first.sort(()=>Math.random()-0.5);
      second.sort(()=>Math.random()-0.5);
      commonSymbol = common;
      cardSymbols = [first, second];
    }

    function drawCard(canvas, symbols) {
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0,0,canvas.width,canvas.height);

      ctx.beginPath();
      ctx.arc(center,center,outerRadius,0,2*Math.PI);
      ctx.lineWidth = 20;
      ctx.strokeStyle = '#2980b9';
      ctx.stroke();
      ctx.closePath();

      ctx.beginPath();
      ctx.arc(center,center,outerRadius-13,0,2*Math.PI);
      ctx.fillStyle = '#fff';
      ctx.fill();
      ctx.closePath();

      for (let i = 0; i < symbols.length; i++) {
        let x, y, size;
        if (i === 0) {
          x = center;
          y = center;
          size = 90;
        } else {
          const angle = ((i-1)/8.0)*(2*Math.PI) - Math.PI/2;
          x = center + innerRadius * Math.cos(angle);
          y = center + innerRadius * Math.sin(angle);
          size = 70;
        }

        const url = symbols[i];
        const img = loadedImages[url];

        if (img) {
          ctx.drawImage(img, x - size/2, y - size/2, size, size);  
        }
      }
    }

    function renderCards() {
      drawCard(card1, cardSymbols[0]);
      drawCard(card2, cardSymbols[1]);
    }

    function startGame() {
      score = 0;
      scoreEl.innerText = 'Skóre: 0';
      startBtn.disabled = true;
      gameRunning = true;
      remainingTime = timeLimit;
      startTime = Date.now();
      generateCards();
      renderCards();
      timerEl.innerText = `Čas: ${remainingTime}s`;
      timer = setInterval(updateTimer, 100);
    }

    function updateTimer() {
      if (!gameRunning) return;
      let elapsed = Math.floor((Date.now()-startTime)/1000);
      let t = remainingTime - elapsed;
      if (t < 0) t = 0;
      timerEl.innerText = `Čas: ${t}s`;
      if(t<=0) endGame();
    }

    function endGame() {
      clearInterval(timer);
      timer = null;
      timerEl.innerText = "Čas: 0s";
      gameRunning = false;
      startBtn.disabled = false;

      // --- NOVÉ: Uložení skóre ---
      sendScoreToBackend(score);

      setTimeout(()=>{
        if(confirm(`KONEC HRY!\nTvoje skóre: ${score} bodů\nChceš hrát znovu?`)) startGame();
      }, 200);
    }

    // kliknutí na KONEC HRY – jen přesměrování
    function stopGame() {
      window.location.href = HOME_URL; 
    }

    function clickCanvas(which, e) {
      if(!gameRunning) return;
      const rect = (which?card2:card1).getBoundingClientRect();
      let clickX = e.clientX-rect.left, clickY = e.clientY-rect.top;
      let idx = which?getSymbolAt(cardSymbols[1],clickX,clickY):getSymbolAt(cardSymbols[0],clickX,clickY);
      if(idx!==null && cardSymbols[which?1:0][idx]===commonSymbol) {
        score++;
        scoreEl.innerText = `Skóre: ${score}`;
        generateCards();
        renderCards();
      } else if(idx!==null) {
        (which?card2:card1).style.border = "4px solid #e74c3c";
        setTimeout(()=>{(which?card2:card1).style.border = "";},120);
      }
    }

    function getSymbolAt(symbols, x, y) {
      let positions = [];
      for(let i=0;i<symbols.length;i++) {
        let pos;
        if(i===0) {
          pos = [center,center,38];
        } else {
          let angle = ((i-1)/8.0)*(2*Math.PI) - Math.PI/2, r = innerRadius;
          pos = [center + r * Math.cos(angle), center + r * Math.sin(angle), 26];
        }
        positions.push(pos);
      }
      for(let i=0;i<positions.length;i++) {
        let [cx,cy,r] = positions[i];
        if((x-cx)**2 + (y-cy)**2 < r*r) return i;
      }
      return null;
    }

    card1.addEventListener('click', clickCanvas.bind(null,0));
    card2.addEventListener('click', clickCanvas.bind(null,1));
    startBtn.addEventListener('click',startGame);
    stopBtn.addEventListener('click',stopGame);

    loadImages(() => {
      generateCards();
      renderCards();
    });
  </script>
</body>
</html>
